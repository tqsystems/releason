# Supabase Usage Examples

This guide provides practical examples of using Supabase in your Next.js application.

## Setting Up a Table

First, create a table in your Supabase project. For this example, we'll create a `todos` table:

```sql
-- In Supabase SQL Editor
create table todos (
  id bigint generated by default as identity primary key,
  user_id text not null,
  title text not null,
  completed boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable Row Level Security
alter table todos enable row level security;

-- Create policy to allow users to see only their own todos
create policy "Users can view their own todos"
  on todos for select
  using (auth.uid()::text = user_id);

-- Create policy to allow users to insert their own todos
create policy "Users can insert their own todos"
  on todos for insert
  with check (auth.uid()::text = user_id);

-- Create policy to allow users to update their own todos
create policy "Users can update their own todos"
  on todos for update
  using (auth.uid()::text = user_id);

-- Create policy to allow users to delete their own todos
create policy "Users can delete their own todos"
  on todos for delete
  using (auth.uid()::text = user_id);
```

## Client-Side Usage

### Reading Data

```typescript
// src/app/todos/page.tsx
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabase";
import { useSession } from "next-auth/react";

interface Todo {
  id: number;
  title: string;
  completed: boolean;
  created_at: string;
}

export default function TodosPage() {
  const { data: session } = useSession();
  const [todos, setTodos] = useState<Todo[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (session?.user?.id) {
      fetchTodos();
    }
  }, [session]);

  async function fetchTodos() {
    try {
      const { data, error } = await supabase
        .from("todos")
        .select("*")
        .eq("user_id", session?.user?.id)
        .order("created_at", { ascending: false });

      if (error) throw error;
      setTodos(data || []);
    } catch (error) {
      console.error("Error fetching todos:", error);
    } finally {
      setLoading(false);
    }
  }

  if (loading) return <div>Loading...</div>;

  return (
    <div>
      <h1>My Todos</h1>
      <ul>
        {todos.map((todo) => (
          <li key={todo.id}>{todo.title}</li>
        ))}
      </ul>
    </div>
  );
}
```

### Creating Data

```typescript
async function createTodo(title: string) {
  try {
    const { data, error } = await supabase
      .from("todos")
      .insert([
        {
          title,
          user_id: session?.user?.id,
          completed: false,
        },
      ])
      .select();

    if (error) throw error;
    
    // Add to local state
    setTodos([data[0], ...todos]);
  } catch (error) {
    console.error("Error creating todo:", error);
  }
}
```

### Updating Data

```typescript
async function toggleTodo(id: number, completed: boolean) {
  try {
    const { error } = await supabase
      .from("todos")
      .update({ completed: !completed })
      .eq("id", id);

    if (error) throw error;

    // Update local state
    setTodos(
      todos.map((todo) =>
        todo.id === id ? { ...todo, completed: !completed } : todo
      )
    );
  } catch (error) {
    console.error("Error updating todo:", error);
  }
}
```

### Deleting Data

```typescript
async function deleteTodo(id: number) {
  try {
    const { error } = await supabase
      .from("todos")
      .delete()
      .eq("id", id);

    if (error) throw error;

    // Update local state
    setTodos(todos.filter((todo) => todo.id !== id));
  } catch (error) {
    console.error("Error deleting todo:", error);
  }
}
```

## Server-Side Usage

### Server Components

```typescript
// src/app/todos/ServerTodoList.tsx
import { supabaseServer } from "@/lib/supabase-server";
import { getCurrentUser } from "@/lib/auth";

export async function ServerTodoList() {
  const user = await getCurrentUser();
  
  if (!user) {
    return <div>Please sign in to view todos</div>;
  }

  const { data: todos, error } = await supabaseServer
    .from("todos")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error fetching todos:", error);
    return <div>Error loading todos</div>;
  }

  return (
    <ul>
      {todos?.map((todo) => (
        <li key={todo.id}>{todo.title}</li>
      ))}
    </ul>
  );
}
```

### API Routes

```typescript
// src/app/api/todos/route.ts
import { NextResponse } from "next/server";
import { supabaseServer } from "@/lib/supabase-server";
import { getSession } from "@/lib/auth";

export async function GET() {
  const session = await getSession();

  if (!session?.user?.id) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const { data, error } = await supabaseServer
    .from("todos")
    .select("*")
    .eq("user_id", session.user.id);

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json(data);
}

export async function POST(request: Request) {
  const session = await getSession();

  if (!session?.user?.id) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const { title } = await request.json();

  const { data, error } = await supabaseServer
    .from("todos")
    .insert([
      {
        title,
        user_id: session.user.id,
        completed: false,
      },
    ])
    .select();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json(data[0]);
}
```

## Real-time Subscriptions

```typescript
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabase";
import { useSession } from "next-auth/react";

export function RealtimeTodos() {
  const { data: session } = useSession();
  const [todos, setTodos] = useState<Todo[]>([]);

  useEffect(() => {
    if (!session?.user?.id) return;

    // Subscribe to changes
    const channel = supabase
      .channel("todos_changes")
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "todos",
          filter: `user_id=eq.${session.user.id}`,
        },
        (payload) => {
          console.log("Change received!", payload);
          // Handle the change (INSERT, UPDATE, DELETE)
          // Update your local state accordingly
        }
      )
      .subscribe();

    // Cleanup subscription
    return () => {
      supabase.removeChannel(channel);
    };
  }, [session]);

  return <div>{/* Your component */}</div>;
}
```

## TypeScript Types

Generate TypeScript types from your Supabase schema:

```bash
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > src/types/supabase.ts
```

Then use them in your code:

```typescript
import { Database } from "@/types/supabase";

type Todo = Database["public"]["Tables"]["todos"]["Row"];
type TodoInsert = Database["public"]["Tables"]["todos"]["Insert"];
type TodoUpdate = Database["public"]["Tables"]["todos"]["Update"];
```

## Best Practices

1. **Use Row Level Security (RLS)**: Always enable RLS and create appropriate policies
2. **Client vs Server**: Use `supabase.ts` for client-side and `supabase-server.ts` for server-side
3. **Error Handling**: Always handle errors from Supabase operations
4. **Type Safety**: Use TypeScript types for better development experience
5. **Authentication**: Verify user authentication before database operations
6. **Indexes**: Add database indexes for frequently queried columns

## Additional Resources

- [Supabase JavaScript Client Docs](https://supabase.com/docs/reference/javascript/introduction)
- [Supabase Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Next.js + Supabase Tutorial](https://supabase.com/docs/guides/getting-started/tutorials/with-nextjs)
